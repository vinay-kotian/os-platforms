{% extends "base.html" %}

{% block title %}Stock Prices - Flask App{% endblock %}

{% block content %}

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert {% if category == 'error' %}alert-error{% else %}alert-success{% endif %} mb-6">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    {% if category == 'error' %}
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    {% else %}
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    {% endif %}
                </svg>
                <span>{{ message }}</span>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{% if access_token %}
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <h2 class="card-title text-lg mb-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
            </svg>
            Zerodha Access Token
        </h2>
        <div class="bg-base-200 rounded-lg p-4">
            <code class="text-sm break-all">{{ access_token }}</code>
        </div>
        {% if request_token %}
        <div class="mt-4">
            <h3 class="text-sm font-semibold mb-2">Request Token:</h3>
            <div class="bg-base-200 rounded-lg p-4">
                <code class="text-sm break-all">{{ request_token }}</code>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if prices %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
            <div class="mb-4">
                <h2 class="card-title text-xl">{{ prices.nifty.name }}</h2>
            </div>
            <div class="mb-4">
                <div class="text-4xl font-bold text-primary mb-2">â‚¹{{ "%.2f"|format(prices.nifty.current_price) }}</div>
                <div class="badge badge-lg {% if prices.nifty.change >= 0 %}badge-success{% else %}badge-error{% endif %}">
                    {% if prices.nifty.change >= 0 %}+{% endif %}{{ "%.2f"|format(prices.nifty.change) }} 
                    ({% if prices.nifty.change_percent >= 0 %}+{% endif %}{{ "%.2f"|format(prices.nifty.change_percent) }}%)
                </div>
            </div>
            <div class="text-sm text-base-content/60 italic">Last updated: {{ prices.nifty.last_updated }}</div>
        </div>
    </div>

    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
            <div class="mb-4">
                <h2 class="card-title text-xl">{{ prices.bank_nifty.name }}</h2>
            </div>
            <div class="mb-4">
                <div class="text-4xl font-bold text-success mb-2">â‚¹{{ "%.2f"|format(prices.bank_nifty.current_price) }}</div>
                <div class="badge badge-lg {% if prices.bank_nifty.change >= 0 %}badge-success{% else %}badge-error{% endif %}">
                    {% if prices.bank_nifty.change >= 0 %}+{% endif %}{{ "%.2f"|format(prices.bank_nifty.change) }} 
                    ({% if prices.bank_nifty.change_percent >= 0 %}+{% endif %}{{ "%.2f"|format(prices.bank_nifty.change_percent) }}%)
                </div>
            </div>
            <div class="text-sm text-base-content/60 italic">Last updated: {{ prices.bank_nifty.last_updated }}</div>
        </div>
    </div>
</div>

<!-- Sleek Refresh Control - Top Right Corner -->
<div class="fixed top-20 right-4 z-40">
    <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-ghost btn-sm bg-base-100/90 backdrop-blur-sm shadow-lg border border-base-300">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span class="text-xs" id="refreshStatusCompact">5s</span>
        </div>
        <ul tabindex="0" class="dropdown-content menu p-2 shadow-xl bg-base-100 rounded-box w-48 border border-base-300">
            <li class="menu-title">
                <span>Refresh Rate</span>
            </li>
            <li><a data-rate="1000" class="refresh-option">1 second</a></li>
            <li><a data-rate="2000" class="refresh-option">2 seconds</a></li>
            <li><a data-rate="5000" class="refresh-option active">5 seconds</a></li>
            <li><a data-rate="10000" class="refresh-option">10 seconds</a></li>
            <li><a data-rate="30000" class="refresh-option">30 seconds</a></li>
            <li><a data-rate="60000" class="refresh-option">1 minute</a></li>
            <li><a data-rate="0" class="refresh-option">Manual only</a></li>
            <div class="divider my-1"></div>
            <li>
                <button id="manualRefresh" class="btn btn-primary btn-sm w-full">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh Now
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- Three Levels Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Nifty 50 Levels -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-xl mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Nifty 50 Levels
            </h2>
            
            <div class="space-y-3">
                <!-- Nifty Level 1 -->
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <input type="number" id="niftyLevel1" placeholder="Level 1" class="input input-bordered input-sm w-full" step="0.01">
                    </div>
                    <button class="btn btn-primary btn-sm px-3" onclick="setNiftyLevel(1)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                    <button class="btn btn-error btn-sm px-3" onclick="deleteNiftyLevel(1)" id="niftyLevel1DeleteBtn" style="display: none;">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-600 truncate" id="niftyLevel1Status">Not set</div>
                        <div class="text-xs text-gray-500 truncate" id="niftyLevel1Distance"></div>
                    </div>
                </div>

                <!-- Nifty Level 2 -->
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <input type="number" id="niftyLevel2" placeholder="Level 2" class="input input-bordered input-sm w-full" step="0.01">
                    </div>
                    <button class="btn btn-primary btn-sm px-3" onclick="setNiftyLevel(2)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                    <button class="btn btn-error btn-sm px-3" onclick="deleteNiftyLevel(2)" id="niftyLevel2DeleteBtn" style="display: none;">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-600 truncate" id="niftyLevel2Status">Not set</div>
                        <div class="text-xs text-gray-500 truncate" id="niftyLevel2Distance"></div>
                    </div>
                </div>

                <!-- Nifty Level 3 -->
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <input type="number" id="niftyLevel3" placeholder="Level 3" class="input input-bordered input-sm w-full" step="0.01">
                    </div>
                    <button class="btn btn-primary btn-sm px-3" onclick="setNiftyLevel(3)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                    <button class="btn btn-error btn-sm px-3" onclick="deleteNiftyLevel(3)" id="niftyLevel3DeleteBtn" style="display: none;">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-600 truncate" id="niftyLevel3Status">Not set</div>
                        <div class="text-xs text-gray-500 truncate" id="niftyLevel3Distance"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Bank Nifty Levels -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-xl mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Bank Nifty Levels
            </h2>
            
            <div class="space-y-3">
                <!-- Bank Nifty Level 1 -->
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <input type="number" id="bankLevel1" placeholder="Level 1" class="input input-bordered input-sm w-full" step="0.01">
                    </div>
                    <button class="btn btn-primary btn-sm px-3" onclick="setBankLevel(1)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                    <button class="btn btn-error btn-sm px-3" onclick="deleteBankLevel(1)" id="bankLevel1DeleteBtn" style="display: none;">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-600 truncate" id="bankLevel1Status">Not set</div>
                        <div class="text-xs text-gray-500 truncate" id="bankLevel1Distance"></div>
                    </div>
                </div>

                <!-- Bank Nifty Level 2 -->
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <input type="number" id="bankLevel2" placeholder="Level 2" class="input input-bordered input-sm w-full" step="0.01">
                    </div>
                    <button class="btn btn-primary btn-sm px-3" onclick="setBankLevel(2)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                    <button class="btn btn-error btn-sm px-3" onclick="deleteBankLevel(2)" id="bankLevel2DeleteBtn" style="display: none;">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-600 truncate" id="bankLevel2Status">Not set</div>
                        <div class="text-xs text-gray-500 truncate" id="bankLevel2Distance"></div>
                    </div>
                </div>

                <!-- Bank Nifty Level 3 -->
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <input type="number" id="bankLevel3" placeholder="Level 3" class="input input-bordered input-sm w-full" step="0.01">
                    </div>
                    <button class="btn btn-primary btn-sm px-3" onclick="setBankLevel(3)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                    <button class="btn btn-error btn-sm px-3" onclick="deleteBankLevel(3)" id="bankLevel3DeleteBtn" style="display: none;">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-600 truncate" id="bankLevel3Status">Not set</div>
                        <div class="text-xs text-gray-500 truncate" id="bankLevel3Distance"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>


{% else %}
<div class="hero bg-base-100 rounded-2xl shadow-xl">
    <div class="hero-content text-center">
        <div class="max-w-md">
            <h1 class="text-3xl font-bold text-error mb-4">Unable to fetch stock prices</h1>
            <p class="text-base-content/70 mb-6">Please make sure you are logged in and try again.</p>
            <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                </svg>
                Connect to Exchange
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function refreshPrices(showButtonState = false) {
    // Show loading state only for manual refreshes
    let refreshBtn = null;
    let originalText = '';
    
    if (showButtonState) {
        refreshBtn = document.querySelector('.btn-primary');
        originalText = refreshBtn.textContent;
        refreshBtn.textContent = 'Refreshing...';
        refreshBtn.disabled = true;
    }
    
    // Make AJAX call to fetch fresh data
    fetch('/stocks/fetch-price')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update Nifty data
            updatePriceCard('nifty', data.nifty);
            
            // Update Bank Nifty data
            updatePriceCard('bank_nifty', data.bank_nifty);
            
            console.log('Prices updated successfully');
        })
        .catch(error => {
            console.error('Error refreshing prices:', error);
            if (showButtonState) {
                alert('Error refreshing prices: ' + error.message);
            }
        })
        .finally(() => {
            // Reset button state only for manual refreshes
            if (showButtonState && refreshBtn) {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            }
        });
}


function updatePriceCard(type, data) {
    const card = document.querySelector(`.grid > div:nth-child(${type === 'nifty' ? '1' : '2'})`);
    
    // Update price
    const priceElement = card.querySelector('.text-4xl');
    priceElement.textContent = `â‚¹${parseFloat(data.current_price).toFixed(2)}`;
    
    // Update change
    const changeElement = card.querySelector('.badge');
    const change = parseFloat(data.change);
    const changePercent = parseFloat(data.change_percent);
    
    changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
    
    // Update change class for styling
    changeElement.className = `badge badge-lg ${change >= 0 ? 'badge-success' : 'badge-error'}`;
    
    // Update last updated time
    const lastUpdatedElement = card.querySelector('.text-base-content\\/60');
    lastUpdatedElement.textContent = `Last updated: ${data.last_updated}`;
}

// Dynamic refresh rate management
let refreshInterval = null;
let currentRefreshRate = 5000; // Default 5 seconds

// Function to start auto-refresh with specified interval
function startAutoRefresh(interval) {
    // Clear existing interval
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    
    // Start new interval if interval > 0
    if (interval > 0) {
        refreshInterval = setInterval(function() {
            refreshPrices(false);
        }, interval);
    }
}

// Function to update refresh status display
function updateRefreshStatus(interval) {
    const statusElement = document.getElementById('refreshStatusCompact');
    if (interval === 0) {
        statusElement.textContent = 'Manual';
    } else {
        const seconds = interval / 1000;
        const displayText = seconds >= 60 ? `${seconds / 60}m` : `${seconds}s`;
        statusElement.textContent = displayText;
    }
    
    // Update active state in dropdown
    document.querySelectorAll('.refresh-option').forEach(option => {
        option.classList.remove('active');
        if (option.getAttribute('data-rate') === interval.toString()) {
            option.classList.add('active');
        }
    });
}

// Function to save refresh rate to localStorage
function saveRefreshRate(rate) {
    localStorage.setItem('eldoradoRefreshRate', rate.toString());
}

// Function to load refresh rate from localStorage
function loadRefreshRate() {
    const saved = localStorage.getItem('eldoradoRefreshRate');
    return saved ? parseInt(saved) : 5000; // Default to 5 seconds
}

// Initialize refresh rate from localStorage
currentRefreshRate = loadRefreshRate();
updateRefreshStatus(currentRefreshRate);
startAutoRefresh(currentRefreshRate);


// Function to fetch current price for three levels
function fetchCurrentPrice() {
    fetch('/stocks/fetch-price')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.prices) {
                // Update Bank Nifty price and levels
                if (data.prices.bank_nifty) {
                    updateBankNiftyPrice(data.prices.bank_nifty.current_price);
                }
                
                // Update Nifty 50 price and levels
                if (data.prices.nifty) {
                    updateNiftyPrice(data.prices.nifty.current_price);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching current price for three levels:', error);
        });
}

// Function to refresh three levels independently
function refreshThreeLevels() {
    fetchCurrentPrice();
}


// Event listeners for refresh controls
document.querySelectorAll('.refresh-option').forEach(option => {
    option.addEventListener('click', function(e) {
        e.preventDefault();
        const newRate = parseInt(this.getAttribute('data-rate'));
        currentRefreshRate = newRate;
        saveRefreshRate(newRate);
        updateRefreshStatus(newRate);
        startAutoRefresh(newRate);
        
        // Close dropdown
        document.querySelector('[tabindex="0"]').blur();
    });
});

document.getElementById('manualRefresh').addEventListener('click', function() {
    const button = this;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = `
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Refreshing...
    `;
    button.disabled = true;
    
    // Perform refresh
    refreshPrices(true);
    refreshThreeLevels(); // Refresh three levels independently
    
    // Reset button after a short delay
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 1000);
});

// Initialize the form on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshThreeLevels(); // Load current price for three levels independently
    
    // Load levels from database
    loadLevelsFromDatabase();
    
    // Initialize all level displays
    for (let i = 1; i <= 3; i++) {
        updateBankLevelDisplay(i);
        updateNiftyLevelDisplay(i);
    }
});

// Three Levels functionality
let bankNiftyPrice = 0;
let niftyPrice = 0;

let bankLevels = {
    1: null,
    2: null,
    3: null
};

let niftyLevels = {
    1: null,
    2: null,
    3: null
};

// Store UUIDs for levels to enable deletion
let bankLevelUuids = {
    1: null,
    2: null,
    3: null
};

let niftyLevelUuids = {
    1: null,
    2: null,
    3: null
};

// Bank Nifty Functions
function setBankLevel(levelNumber) {
    const input = document.getElementById(`bankLevel${levelNumber}`);
    const value = parseFloat(input.value);
    
    if (isNaN(value) || value <= 0) {
        alert('Please enter a valid positive number for Bank Nifty Level ' + levelNumber);
        return;
    }
    
    bankLevels[levelNumber] = value;
    updateBankLevelDisplay(levelNumber);
    
    // Save to database
    saveLevelToDatabase('BANK_NIFTY', levelNumber, value);
    
    console.log(`Bank Nifty Level ${levelNumber} set to: ${value}`);
}

function updateBankLevelDisplay(levelNumber) {
    const statusElement = document.getElementById(`bankLevel${levelNumber}Status`);
    const distanceElement = document.getElementById(`bankLevel${levelNumber}Distance`);
    const deleteBtn = document.getElementById(`bankLevel${levelNumber}DeleteBtn`);
    
    if (bankLevels[levelNumber] !== null) {
        statusElement.textContent = `â‚¹${bankLevels[levelNumber].toFixed(2)}`;
        statusElement.className = 'text-xs text-success font-semibold';
        
        // Show delete button when level is set
        if (deleteBtn) {
            deleteBtn.style.display = 'block';
        }
        
        if (bankNiftyPrice > 0) {
            const distance = Math.abs(bankNiftyPrice - bankLevels[levelNumber]);
            const distancePercent = (distance / bankLevels[levelNumber]) * 100;
            distanceElement.textContent = `â‚¹${distance.toFixed(2)} (${distancePercent.toFixed(1)}%)`;
            
            // Color code based on distance
            if (distancePercent <= 1) {
                distanceElement.className = 'text-xs text-error font-semibold';
            } else if (distancePercent <= 5) {
                distanceElement.className = 'text-xs text-warning font-semibold';
            } else {
                distanceElement.className = 'text-xs text-gray-500';
            }
        }
    } else {
        statusElement.textContent = 'Not set';
        statusElement.className = 'text-xs text-gray-600';
        distanceElement.textContent = '';
        
        // Hide delete button when level is not set
        if (deleteBtn) {
            deleteBtn.style.display = 'none';
        }
    }
}

function deleteBankLevel(levelNumber) {
    if (!bankLevelUuids[levelNumber]) {
        alert('No level to delete for Bank Nifty Level ' + levelNumber);
        return;
    }
    
    if (confirm(`Are you sure you want to delete Bank Nifty Level ${levelNumber} (â‚¹${bankLevels[levelNumber].toFixed(2)})?`)) {
        // Show loading state
        const deleteBtn = document.getElementById(`bankLevel${levelNumber}DeleteBtn`);
        const originalContent = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
        deleteBtn.disabled = true;
        
        // Call delete API
        fetch(`/three-levels/delete/${bankLevelUuids[levelNumber]}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear the level locally
                bankLevels[levelNumber] = null;
                bankLevelUuids[levelNumber] = null;
                document.getElementById(`bankLevel${levelNumber}`).value = '';
                updateBankLevelDisplay(levelNumber);
                console.log(`Bank Nifty Level ${levelNumber} deleted successfully`);
            } else {
                alert('Error deleting level: ' + (data.error || 'Unknown error'));
                // Reset button state
                deleteBtn.innerHTML = originalContent;
                deleteBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting level: ' + error.message);
            // Reset button state
            deleteBtn.innerHTML = originalContent;
            deleteBtn.disabled = false;
        });
    }
}

// Nifty 50 Functions
function setNiftyLevel(levelNumber) {
    const input = document.getElementById(`niftyLevel${levelNumber}`);
    const value = parseFloat(input.value);
    
    if (isNaN(value) || value <= 0) {
        alert('Please enter a valid positive number for Nifty Level ' + levelNumber);
        return;
    }
    
    niftyLevels[levelNumber] = value;
    updateNiftyLevelDisplay(levelNumber);
    
    // Save to database
    saveLevelToDatabase('NIFTY_50', levelNumber, value);
    
    console.log(`Nifty Level ${levelNumber} set to: ${value}`);
}

function updateNiftyLevelDisplay(levelNumber) {
    const statusElement = document.getElementById(`niftyLevel${levelNumber}Status`);
    const distanceElement = document.getElementById(`niftyLevel${levelNumber}Distance`);
    const deleteBtn = document.getElementById(`niftyLevel${levelNumber}DeleteBtn`);
    
    if (niftyLevels[levelNumber] !== null) {
        statusElement.textContent = `â‚¹${niftyLevels[levelNumber].toFixed(2)}`;
        statusElement.className = 'text-xs text-success font-semibold';
        
        // Show delete button when level is set
        if (deleteBtn) {
            deleteBtn.style.display = 'block';
        }
        
        if (niftyPrice > 0) {
            const distance = Math.abs(niftyPrice - niftyLevels[levelNumber]);
            const distancePercent = (distance / niftyLevels[levelNumber]) * 100;
            distanceElement.textContent = `â‚¹${distance.toFixed(2)} (${distancePercent.toFixed(1)}%)`;
            
            // Color code based on distance
            if (distancePercent <= 1) {
                distanceElement.className = 'text-xs text-error font-semibold';
            } else if (distancePercent <= 5) {
                distanceElement.className = 'text-xs text-warning font-semibold';
            } else {
                distanceElement.className = 'text-xs text-gray-500';
            }
        }
    } else {
        statusElement.textContent = 'Not set';
        statusElement.className = 'text-xs text-gray-600';
        distanceElement.textContent = '';
        
        // Hide delete button when level is not set
        if (deleteBtn) {
            deleteBtn.style.display = 'none';
        }
    }
}

function deleteNiftyLevel(levelNumber) {
    if (!niftyLevelUuids[levelNumber]) {
        alert('No level to delete for Nifty Level ' + levelNumber);
        return;
    }
    
    if (confirm(`Are you sure you want to delete Nifty Level ${levelNumber} (â‚¹${niftyLevels[levelNumber].toFixed(2)})?`)) {
        // Show loading state
        const deleteBtn = document.getElementById(`niftyLevel${levelNumber}DeleteBtn`);
        const originalContent = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
        deleteBtn.disabled = true;
        
        // Call delete API
        fetch(`/three-levels/delete/${niftyLevelUuids[levelNumber]}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear the level locally
                niftyLevels[levelNumber] = null;
                niftyLevelUuids[levelNumber] = null;
                document.getElementById(`niftyLevel${levelNumber}`).value = '';
                updateNiftyLevelDisplay(levelNumber);
                console.log(`Nifty Level ${levelNumber} deleted successfully`);
            } else {
                alert('Error deleting level: ' + (data.error || 'Unknown error'));
                // Reset button state
                deleteBtn.innerHTML = originalContent;
                deleteBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting level: ' + error.message);
            // Reset button state
            deleteBtn.innerHTML = originalContent;
            deleteBtn.disabled = false;
        });
    }
}

function updateBankNiftyPrice(price) {
    const previousPrice = bankNiftyPrice;
    bankNiftyPrice = price;
    document.getElementById('bankCurrentPriceDisplay').textContent = `â‚¹${price.toFixed(2)}`;
    document.getElementById('bankPriceUpdateTime').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    
    // Check for level breaches
    checkBankLevelBreaches(price, previousPrice);
    
    // Update all bank level displays
    for (let i = 1; i <= 3; i++) {
        updateBankLevelDisplay(i);
    }
}

function updateNiftyPrice(price) {
    const previousPrice = niftyPrice;
    niftyPrice = price;
    document.getElementById('niftyCurrentPriceDisplay').textContent = `â‚¹${price.toFixed(2)}`;
    document.getElementById('niftyPriceUpdateTime').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    
    // Check for level breaches
    checkNiftyLevelBreaches(price, previousPrice);
    
    // Update all nifty level displays
    for (let i = 1; i <= 3; i++) {
        updateNiftyLevelDisplay(i);
    }
}

// Level breach detection functions
function checkBankLevelBreaches(currentPrice, previousPrice) {
    for (let i = 1; i <= 3; i++) {
        if (bankLevels[i] !== null) {
            const level = bankLevels[i];
            const breach = checkLevelBreach(currentPrice, previousPrice, level);
            
            if (breach.breached) {
                showBreachNotification('Bank Nifty', i, level, currentPrice, breach.direction);
                updateBankLevelBreachStatus(i, breach);
            } else {
                updateBankLevelBreachStatus(i, { breached: false });
            }
        }
    }
}

function checkNiftyLevelBreaches(currentPrice, previousPrice) {
    for (let i = 1; i <= 3; i++) {
        if (niftyLevels[i] !== null) {
            const level = niftyLevels[i];
            const breach = checkLevelBreach(currentPrice, previousPrice, level);
            
            if (breach.breached) {
                showBreachNotification('Nifty 50', i, level, currentPrice, breach.direction);
                updateNiftyLevelBreachStatus(i, breach);
            } else {
                updateNiftyLevelBreachStatus(i, { breached: false });
            }
        }
    }
}

function checkLevelBreach(currentPrice, previousPrice, level) {
    if (!previousPrice || previousPrice === 0) {
        // No previous price data, can't determine crossing
        return { breached: false, direction: null };
    }
    
    // Check if price crossed the level
    const wasAbove = previousPrice > level;
    const isAbove = currentPrice > level;
    const wasBelow = previousPrice < level;
    const isBelow = currentPrice < level;
    
    // Determine if there was a crossing
    if (wasAbove && isBelow) {
        // Price crossed down through the level
        return { breached: true, direction: 'down' };
    } else if (wasBelow && isAbove) {
        // Price crossed up through the level
        return { breached: true, direction: 'up' };
    } else if (Math.abs(currentPrice - level) <= 0.01) {
        // Price is exactly at the level (within 0.01 tolerance)
        return { breached: true, direction: 'at_level' };
    }
    
    return { breached: false, direction: null };
}

function showBreachNotification(indexName, levelNumber, level, currentPrice, direction) {
    const directionText = direction === 'up' ? 'UP' : direction === 'down' ? 'DOWN' : 'AT';
    const directionColor = direction === 'up' ? 'text-success' : direction === 'down' ? 'text-error' : 'text-warning';
    
    console.log(`ðŸš¨ BREACH DETECTED: ${indexName} Level ${levelNumber} (â‚¹${level.toFixed(2)}) crossed ${directionText} at â‚¹${currentPrice.toFixed(2)}`);
    
    // Create a visual notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${direction === 'up' ? 'success' : direction === 'down' ? 'error' : 'warning'} mb-2`;
    notification.innerHTML = `
        <div class="flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div>
                <div class="font-semibold">${indexName} Level ${levelNumber} Breached!</div>
                <div class="text-sm">Level: â‚¹${level.toFixed(2)} | Price: â‚¹${currentPrice.toFixed(2)} | Direction: <span class="${directionColor} font-bold">${directionText}</span></div>
            </div>
        </div>
    `;
    
    // Add to alerts section or create a notifications area
    const alertsSection = document.querySelector('.card-body');
    if (alertsSection) {
        alertsSection.insertBefore(notification, alertsSection.firstChild);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 10000);
    }
}

function updateBankLevelBreachStatus(levelNumber, breach) {
    const statusElement = document.getElementById(`bankLevel${levelNumber}Status`);
    const distanceElement = document.getElementById(`bankLevel${levelNumber}Distance`);
    
    if (breach.breached) {
        const directionIcon = breach.direction === 'up' ? 'â†—ï¸' : breach.direction === 'down' ? 'â†˜ï¸' : 'âš¡';
        const directionColor = breach.direction === 'up' ? 'text-success' : breach.direction === 'down' ? 'text-error' : 'text-warning';
        
        statusElement.innerHTML = `${directionIcon} BREACHED`;
        statusElement.className = `text-xs ${directionColor} font-bold animate-pulse`;
        
        distanceElement.textContent = `Direction: ${breach.direction.toUpperCase()}`;
        distanceElement.className = `text-xs ${directionColor} font-semibold`;
    } else {
        // Reset to normal display
        updateBankLevelDisplay(levelNumber);
    }
}

function updateNiftyLevelBreachStatus(levelNumber, breach) {
    const statusElement = document.getElementById(`niftyLevel${levelNumber}Status`);
    const distanceElement = document.getElementById(`niftyLevel${levelNumber}Distance`);
    
    if (breach.breached) {
        const directionIcon = breach.direction === 'up' ? 'â†—ï¸' : breach.direction === 'down' ? 'â†˜ï¸' : 'âš¡';
        const directionColor = breach.direction === 'up' ? 'text-success' : breach.direction === 'down' ? 'text-error' : 'text-warning';
        
        statusElement.innerHTML = `${directionIcon} BREACHED`;
        statusElement.className = `text-xs ${directionColor} font-bold animate-pulse`;
        
        distanceElement.textContent = `Direction: ${breach.direction.toUpperCase()}`;
        distanceElement.className = `text-xs ${directionColor} font-semibold`;
    } else {
        // Reset to normal display
        updateNiftyLevelDisplay(levelNumber);
    }
}

// Database functions for three levels
function saveLevelToDatabase(indexType, levelNumber, levelValue) {
    fetch('/three-levels/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            index_type: indexType,
            level_number: levelNumber,
            level_value: levelValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`Level saved: ${indexType} Level ${levelNumber} = ${levelValue}`);
            // Store the UUID for future reference and deletion
            if (data.uuid) {
                console.log(`Level UUID: ${data.uuid}`);
                if (indexType === 'BANK_NIFTY') {
                    bankLevelUuids[levelNumber] = data.uuid;
                } else if (indexType === 'NIFTY_50') {
                    niftyLevelUuids[levelNumber] = data.uuid;
                }
            }
        } else {
            console.error('Error saving level:', data.error);
        }
    })
    .catch(error => {
        console.error('Error saving level:', error);
    });
}

function loadLevelsFromDatabase() {
    fetch('/three-levels/get')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.levels) {
                // Load Bank Nifty levels
                if (data.levels.BANK_NIFTY) {
                    for (let i = 1; i <= 3; i++) {
                        if (data.levels.BANK_NIFTY[i] && data.levels.BANK_NIFTY[i].value) {
                            bankLevels[i] = data.levels.BANK_NIFTY[i].value;
                            bankLevelUuids[i] = data.levels.BANK_NIFTY[i].uuid;
                            document.getElementById(`bankLevel${i}`).value = data.levels.BANK_NIFTY[i].value;
                            updateBankLevelDisplay(i);
                        }
                    }
                }
                
                // Load Nifty 50 levels
                if (data.levels.NIFTY_50) {
                    for (let i = 1; i <= 3; i++) {
                        if (data.levels.NIFTY_50[i] && data.levels.NIFTY_50[i].value) {
                            niftyLevels[i] = data.levels.NIFTY_50[i].value;
                            niftyLevelUuids[i] = data.levels.NIFTY_50[i].uuid;
                            document.getElementById(`niftyLevel${i}`).value = data.levels.NIFTY_50[i].value;
                            updateNiftyLevelDisplay(i);
                        }
                    }
                }
                
                console.log('Levels loaded from database');
            }
        })
        .catch(error => {
            console.error('Error loading levels from database:', error);
        });
}
</script>
{% endblock %}