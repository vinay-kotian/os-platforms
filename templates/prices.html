{% extends "base.html" %}

{% block title %}Stock Prices - Flask App{% endblock %}

{% block content %}

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert {% if category == 'error' %}alert-error{% else %}alert-success{% endif %} mb-6">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    {% if category == 'error' %}
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    {% else %}
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    {% endif %}
                </svg>
                <span>{{ message }}</span>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{% if access_token %}
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <h2 class="card-title text-lg mb-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
            </svg>
            Zerodha Access Token
        </h2>
        <div class="bg-base-200 rounded-lg p-4">
            <code class="text-sm break-all">{{ access_token }}</code>
        </div>
        {% if request_token %}
        <div class="mt-4">
            <h3 class="text-sm font-semibold mb-2">Request Token:</h3>
            <div class="bg-base-200 rounded-lg p-4">
                <code class="text-sm break-all">{{ request_token }}</code>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if prices %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
            <div class="mb-4">
                <h2 class="card-title text-xl">{{ prices.nifty.name }}</h2>
            </div>
            <div class="mb-4">
                <div class="text-4xl font-bold text-primary mb-2">â‚¹{{ "%.2f"|format(prices.nifty.current_price) }}</div>
                <div class="badge badge-lg {% if prices.nifty.change >= 0 %}badge-success{% else %}badge-error{% endif %}">
                    {% if prices.nifty.change >= 0 %}+{% endif %}{{ "%.2f"|format(prices.nifty.change) }} 
                    ({% if prices.nifty.change_percent >= 0 %}+{% endif %}{{ "%.2f"|format(prices.nifty.change_percent) }}%)
                </div>
            </div>
            <div class="text-sm text-base-content/60 italic">Last updated: {{ prices.nifty.last_updated }}</div>
        </div>
    </div>

    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
            <div class="mb-4">
                <h2 class="card-title text-xl">{{ prices.bank_nifty.name }}</h2>
            </div>
            <div class="mb-4">
                <div class="text-4xl font-bold text-success mb-2">â‚¹{{ "%.2f"|format(prices.bank_nifty.current_price) }}</div>
                <div class="badge badge-lg {% if prices.bank_nifty.change >= 0 %}badge-success{% else %}badge-error{% endif %}">
                    {% if prices.bank_nifty.change >= 0 %}+{% endif %}{{ "%.2f"|format(prices.bank_nifty.change) }} 
                    ({% if prices.bank_nifty.change_percent >= 0 %}+{% endif %}{{ "%.2f"|format(prices.bank_nifty.change_percent) }}%)
                </div>
            </div>
            <div class="text-sm text-base-content/60 italic">Last updated: {{ prices.bank_nifty.last_updated }}</div>
        </div>
    </div>
</div>

<!-- Sleek Refresh Control - Top Right Corner -->
<div class="fixed top-20 right-4 z-40">
    <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-ghost btn-sm bg-base-100/90 backdrop-blur-sm shadow-lg border border-base-300">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span class="text-xs" id="refreshStatusCompact">5s</span>
        </div>
        <ul tabindex="0" class="dropdown-content menu p-2 shadow-xl bg-base-100 rounded-box w-48 border border-base-300">
            <li class="menu-title">
                <span>Refresh Rate</span>
            </li>
            <li><a data-rate="1000" class="refresh-option">1 second</a></li>
            <li><a data-rate="2000" class="refresh-option">2 seconds</a></li>
            <li><a data-rate="5000" class="refresh-option active">5 seconds</a></li>
            <li><a data-rate="10000" class="refresh-option">10 seconds</a></li>
            <li><a data-rate="30000" class="refresh-option">30 seconds</a></li>
            <li><a data-rate="60000" class="refresh-option">1 minute</a></li>
            <li><a data-rate="0" class="refresh-option">Manual only</a></li>
            <div class="divider my-1"></div>
            <li>
                <button id="manualRefresh" class="btn btn-primary btn-sm w-full">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh Now
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- Three Levels Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Nifty 50 Levels -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex items-center justify-between mb-4">
                <h2 class="card-title text-xl">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Nifty 50 Levels
                </h2>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-success" onclick="addNiftyLevel()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Level
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="clearNiftyLevels()" title="Clear all levels">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Clear All
                    </button>
                </div>
            </div>
            
            <div id="niftyLevelsContainer" class="space-y-3">
                <!-- Levels will be dynamically added here -->
            </div>

        </div>
    </div>

    <!-- Bank Nifty Levels -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex items-center justify-between mb-4">
                <h2 class="card-title text-xl">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Bank Nifty Levels
                </h2>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-success" onclick="addBankLevel()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Level
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="clearBankLevels()" title="Clear all levels">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Clear All
                    </button>
                </div>
            </div>
            
            <div id="bankLevelsContainer" class="space-y-3">
                <!-- Levels will be dynamically added here -->
            </div>

        </div>
    </div>
</div>

<!-- Paper Trades Section -->
<div class="card bg-base-100 shadow-xl mb-8">
    <div class="card-body">
        <div class="flex items-center justify-between mb-4">
            <h2 class="card-title text-xl">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Paper Trades
            </h2>
            <div class="flex items-center gap-2">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-xs">Date Filter</span>
                    </label>
                    <input type="date" id="paperTradesDateFilter" class="input input-bordered input-sm w-40" />
                </div>
                <button id="refreshPaperTrades" class="btn btn-sm btn-primary">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
        
        <div id="paperTradesContainer" class="overflow-x-auto">
            <div class="text-center text-base-content/60 py-8">
                <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p>Loading paper trades...</p>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="hero bg-base-100 rounded-2xl shadow-xl">
    <div class="hero-content text-center">
        <div class="max-w-md">
            <h1 class="text-3xl font-bold text-error mb-4">Unable to fetch stock prices</h1>
            <p class="text-base-content/70 mb-6">Please make sure you are logged in and try again.</p>
            <a href="{{ url_for('auth.zerodha_login') }}" class="btn btn-primary btn-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                </svg>
                Connect to Exchange
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
// Initialize SocketIO connection for continuous price streaming
const socket = io();

// Connection status
let isConnected = false;

socket.on('connect', function() {
    console.log('Connected to WebSocket server');
    isConnected = true;
    updateConnectionStatus(true);
});

socket.on('disconnect', function() {
    console.log('Disconnected from WebSocket server');
    isConnected = false;
    updateConnectionStatus(false);
});

socket.on('connected', function(data) {
    console.log('WebSocket handshake complete:', data);
});

// Listen for continuous price updates
socket.on('price_update', function(data) {
    console.log('Received price update:', data);
    
    // Update Nifty data if available
    if (data.nifty) {
        updatePriceCard('nifty', data.nifty);
        if (data.nifty.current_price) {
            updateNiftyPrice(data.nifty.current_price);
        }
    }
    
    // Update Bank Nifty data if available
    if (data.bank_nifty) {
        updatePriceCard('bank_nifty', data.bank_nifty);
        if (data.bank_nifty.current_price) {
            updateBankNiftyPrice(data.bank_nifty.current_price);
        }
    }
});

function updateConnectionStatus(connected) {
    const statusElement = document.getElementById('refreshStatusCompact');
    if (statusElement) {
        if (connected) {
            statusElement.textContent = 'Live';
            statusElement.parentElement.classList.add('text-success');
        } else {
            statusElement.textContent = 'Offline';
            statusElement.parentElement.classList.remove('text-success');
        }
    }
}

// Legacy refresh function (kept for manual refresh button)
function refreshPrices(showButtonState = false) {
    // Show loading state only for manual refreshes
    let refreshBtn = null;
    let originalText = '';
    
    if (showButtonState) {
        refreshBtn = document.querySelector('.btn-primary');
        originalText = refreshBtn.textContent;
        refreshBtn.textContent = 'Refreshing...';
        refreshBtn.disabled = true;
    }
    
    // Make AJAX call to fetch fresh data via WebSocket
    fetch('/stocks/fetch-price-websocket')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update Nifty data
            updatePriceCard('nifty', data.nifty);
            
            // Update Bank Nifty data
            updatePriceCard('bank_nifty', data.bank_nifty);
            
            console.log('Prices updated successfully via WebSocket');
        })
        .catch(error => {
            console.error('Error refreshing prices:', error);
            if (showButtonState) {
                alert('Error refreshing prices: ' + error.message);
            }
        })
        .finally(() => {
            // Reset button state only for manual refreshes
            if (showButtonState && refreshBtn) {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            }
        });
}


function updatePriceCard(type, data) {
    const card = document.querySelector(`.grid > div:nth-child(${type === 'nifty' ? '1' : '2'})`);
    if (!card) {
        console.warn(`Card not found for type: ${type}`);
        return;
    }
    
    // Update price
    const priceElement = card.querySelector('.text-4xl');
    if (priceElement && data.current_price !== undefined) {
        priceElement.textContent = `â‚¹${parseFloat(data.current_price).toFixed(2)}`;
    }
    
    // Update change and percentage
    const changeElement = card.querySelector('.badge');
    if (changeElement) {
        const change = data.change !== undefined ? parseFloat(data.change) : 0;
        const changePercent = data.change_percent !== undefined ? parseFloat(data.change_percent) : 0;
        
        // Check if values are valid numbers
        if (!isNaN(change) && !isNaN(changePercent)) {
            changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
        } else {
            // Fallback: calculate from current_price and previous_close if available
            const currentPrice = parseFloat(data.current_price);
            const previousClose = data.previous_close ? parseFloat(data.previous_close) : null;
            
            if (!isNaN(currentPrice) && previousClose && previousClose > 0) {
                const calculatedChange = currentPrice - previousClose;
                const calculatedChangePercent = (calculatedChange / previousClose) * 100;
                changeElement.textContent = `${calculatedChange >= 0 ? '+' : ''}${calculatedChange.toFixed(2)} (${calculatedChangePercent >= 0 ? '+' : ''}${calculatedChangePercent.toFixed(2)}%)`;
            } else {
                changeElement.textContent = 'N/A';
            }
        }
        
        // Update change class for styling
        const changeValue = !isNaN(change) ? change : (data.current_price && data.previous_close ? parseFloat(data.current_price) - parseFloat(data.previous_close) : 0);
        changeElement.className = `badge badge-lg ${changeValue >= 0 ? 'badge-success' : 'badge-error'}`;
    }
    
    // Update last updated time
    const lastUpdatedElement = card.querySelector('.text-base-content\\/60');
    if (lastUpdatedElement && data.last_updated) {
        lastUpdatedElement.textContent = `Last updated: ${data.last_updated}`;
    }
}

// Function to update refresh status display
function updateRefreshStatus() {
    const statusElement = document.getElementById('refreshStatusCompact');
    if (statusElement) {
        if (isConnected) {
            statusElement.textContent = 'Live';
        } else {
            statusElement.textContent = 'Connecting...';
        }
    }
    
    // Update active state in dropdown (disabled for WebSocket mode)
    document.querySelectorAll('.refresh-option').forEach(option => {
        option.classList.remove('active');
    });
}

// Initialize - WebSocket connection is automatic
updateRefreshStatus();


// Function to fetch current price for three levels (fallback if WebSocket fails)
function fetchCurrentPrice() {
    // Prices are automatically updated via WebSocket, but we can fetch once on load if WebSocket fails
    // Only fetch if WebSocket is not connected after a reasonable timeout
    setTimeout(() => {
        if (!isConnected) {
            console.log('WebSocket not connected, using fallback fetch');
            fetch('/stocks/fetch-price-websocket')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching prices:', data.error);
                        return;
                    }
                    
                    // Update Bank Nifty price and levels
                    if (data.bank_nifty && data.bank_nifty.current_price) {
                        updateBankNiftyPrice(data.bank_nifty.current_price);
                    }
                    
                    // Update Nifty 50 price and levels
                    if (data.nifty && data.nifty.current_price) {
                        updateNiftyPrice(data.nifty.current_price);
                    }
                })
                .catch(error => {
                    console.error('Error fetching current price for three levels:', error);
                });
        } else {
            console.log('WebSocket connected, using real-time updates');
        }
    }, 2000); // Wait 2 seconds for WebSocket to connect
}

// Function to refresh three levels independently (now handled by WebSocket)
function refreshThreeLevels() {
    // WebSocket automatically updates prices via price_update events
    // Only use fallback if WebSocket is not connected
    if (!isConnected) {
        fetchCurrentPrice();
    }
}


// Event listeners for refresh controls (disabled - using WebSocket)
document.querySelectorAll('.refresh-option').forEach(option => {
    option.addEventListener('click', function(e) {
        e.preventDefault();
        // Show message that WebSocket is being used
        alert('Using continuous WebSocket streaming. Prices update automatically in real-time.');
        
        // Close dropdown
        document.querySelector('[tabindex="0"]').blur();
    });
});

document.getElementById('manualRefresh').addEventListener('click', function() {
    const button = this;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = `
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Refreshing...
    `;
    button.disabled = true;
    
    // Perform refresh
    refreshPrices(true);
    refreshThreeLevels(); // Refresh three levels independently
    
    // Reset button after a short delay
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 1000);
});

// Initialize the form on page load
document.addEventListener('DOMContentLoaded', function() {
    // Wait for WebSocket connection before initializing
    // Prices will be updated automatically via WebSocket
    // Only use fallback if WebSocket fails to connect
    
    // Load levels from database
    // Use a small delay to ensure DOM is fully ready
    setTimeout(() => {
        loadLevelsFromDatabase(false); // Load all levels
    }, 100);
    
    // Set up fallback fetch only if WebSocket doesn't connect within 3 seconds
    setTimeout(() => {
        if (!isConnected) {
            console.log('WebSocket connection timeout, using fallback');
            refreshThreeLevels();
        }
    }, 3000);
});

// Dynamic Levels functionality
let bankNiftyPrice = 0;
let niftyPrice = 0;

// Store levels as arrays with UUIDs
let bankLevels = []; // Array of {uuid, value}
let niftyLevels = []; // Array of {uuid, value}

// Bank Nifty Functions - Dynamic Levels
function addBankLevel() {
    // Create a new empty level row
    const levelUuid = 'temp_' + Date.now();
    bankLevels.push({uuid: levelUuid, value: null});
    renderBankLevels();
}

function setBankLevel(uuid) {
    const levelIndex = bankLevels.findIndex(l => l.uuid === uuid);
    if (levelIndex === -1) return;
    
    const input = document.getElementById(`bankLevelInput_${uuid}`);
    const value = parseFloat(input.value);
    
    if (isNaN(value) || value <= 0) {
        alert('Please enter a valid positive number');
        return;
    }
    
    const existingUuid = bankLevels[levelIndex].uuid.startsWith('temp_') ? null : bankLevels[levelIndex].uuid;
    bankLevels[levelIndex].value = value;
    
    // Save to database
    saveLevelToDatabase('BANK_NIFTY', value, existingUuid)
        .then(() => {
            console.log(`Bank Nifty Level set to: ${value}`);
            renderBankLevels();
        })
        .catch(error => {
            alert('Error saving level: ' + error.message);
        });
}

function deleteBankLevel(uuid) {
    const levelIndex = bankLevels.findIndex(l => l.uuid === uuid);
    if (levelIndex === -1) return;
    
    const level = bankLevels[levelIndex];
    if (!level.value) {
        // Just remove from array if not saved yet
        bankLevels.splice(levelIndex, 1);
        renderBankLevels();
        return;
    }
    
    if (confirm(`Are you sure you want to delete this level (â‚¹${level.value.toFixed(2)})?`)) {
        // If it's a temp UUID, just remove it
        if (uuid.startsWith('temp_')) {
            bankLevels.splice(levelIndex, 1);
            renderBankLevels();
            return;
        }
        
        // Call delete API
        fetch(`/levels/delete/${uuid}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bankLevels.splice(levelIndex, 1);
                renderBankLevels();
                console.log('Bank Nifty Level deleted successfully');
            } else {
                alert('Error deleting level: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting level: ' + error.message);
        });
    }
}

function clearBankLevels() {
    if (confirm('Are you sure you want to clear all Bank Nifty levels?')) {
        fetch('/levels/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                index_type: 'BANK_NIFTY',
                today_only: false
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bankLevels = [];
                renderBankLevels();
                alert(`Cleared ${data.deleted_count} level(s)`);
            } else {
                alert('Error clearing levels: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error clearing levels: ' + error.message);
        });
    }
}

function renderBankLevels() {
    const container = document.getElementById('bankLevelsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    bankLevels.forEach((level, index) => {
        const levelDiv = document.createElement('div');
        levelDiv.className = 'flex items-center gap-2';
        levelDiv.innerHTML = `
            <div class="flex-1">
                <input type="number" id="bankLevelInput_${level.uuid}" 
                       placeholder="Enter level value" 
                       class="input input-bordered input-sm w-full" 
                       step="0.01" 
                       value="${level.value || ''}">
            </div>
            <button class="btn btn-primary btn-sm px-3" onclick="setBankLevel('${level.uuid}')">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </button>
            <button class="btn btn-error btn-sm px-3" onclick="deleteBankLevel('${level.uuid}')">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
            <div class="flex-1 min-w-0">
                <div class="text-xs text-gray-600 truncate" id="bankLevelStatus_${level.uuid}">
                    ${level.value ? `â‚¹${level.value.toFixed(2)}` : 'Not set'}
                </div>
                <div class="text-xs text-gray-500 truncate" id="bankLevelDistance_${level.uuid}"></div>
            </div>
        `;
        container.appendChild(levelDiv);
    });
    
    // Update displays for all levels
    bankLevels.forEach(level => {
        updateBankLevelDisplay(level.uuid);
    });
}

function updateBankLevelDisplay(uuid) {
    const level = bankLevels.find(l => l.uuid === uuid);
    if (!level) return;
    
    const statusElement = document.getElementById(`bankLevelStatus_${uuid}`);
    const distanceElement = document.getElementById(`bankLevelDistance_${uuid}`);
    
    if (!statusElement || !distanceElement) return;
    
    if (level.value !== null) {
        statusElement.textContent = `â‚¹${level.value.toFixed(2)}`;
        statusElement.className = 'text-xs text-success font-semibold';
        
        if (bankNiftyPrice > 0) {
            const distance = Math.abs(bankNiftyPrice - level.value);
            const distancePercent = (distance / level.value) * 100;
            distanceElement.textContent = `â‚¹${distance.toFixed(2)} (${distancePercent.toFixed(1)}%)`;
            
            // Color code based on distance
            if (distancePercent <= 1) {
                distanceElement.className = 'text-xs text-error font-semibold';
            } else if (distancePercent <= 5) {
                distanceElement.className = 'text-xs text-warning font-semibold';
            } else {
                distanceElement.className = 'text-xs text-gray-500';
            }
        }
    } else {
        statusElement.textContent = 'Not set';
        statusElement.className = 'text-xs text-gray-600';
        distanceElement.textContent = '';
    }
}


// Nifty 50 Functions - Dynamic Levels
function addNiftyLevel() {
    // Create a new empty level row
    const levelUuid = 'temp_' + Date.now();
    niftyLevels.push({uuid: levelUuid, value: null});
    renderNiftyLevels();
}

function setNiftyLevel(uuid) {
    const levelIndex = niftyLevels.findIndex(l => l.uuid === uuid);
    if (levelIndex === -1) return;
    
    const input = document.getElementById(`niftyLevelInput_${uuid}`);
    const value = parseFloat(input.value);
    
    if (isNaN(value) || value <= 0) {
        alert('Please enter a valid positive number');
        return;
    }
    
    const existingUuid = niftyLevels[levelIndex].uuid.startsWith('temp_') ? null : niftyLevels[levelIndex].uuid;
    niftyLevels[levelIndex].value = value;
    
    // Save to database
    saveLevelToDatabase('NIFTY_50', value, existingUuid)
        .then(() => {
            console.log(`Nifty Level set to: ${value}`);
            renderNiftyLevels();
        })
        .catch(error => {
            alert('Error saving level: ' + error.message);
        });
}

function deleteNiftyLevel(uuid) {
    const levelIndex = niftyLevels.findIndex(l => l.uuid === uuid);
    if (levelIndex === -1) return;
    
    const level = niftyLevels[levelIndex];
    if (!level.value) {
        // Just remove from array if not saved yet
        niftyLevels.splice(levelIndex, 1);
        renderNiftyLevels();
        return;
    }
    
    if (confirm(`Are you sure you want to delete this level (â‚¹${level.value.toFixed(2)})?`)) {
        // If it's a temp UUID, just remove it
        if (uuid.startsWith('temp_')) {
            niftyLevels.splice(levelIndex, 1);
            renderNiftyLevels();
            return;
        }
        
        // Call delete API
        fetch(`/levels/delete/${uuid}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                niftyLevels.splice(levelIndex, 1);
                renderNiftyLevels();
                console.log('Nifty Level deleted successfully');
            } else {
                alert('Error deleting level: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting level: ' + error.message);
        });
    }
}

function clearNiftyLevels() {
    if (confirm('Are you sure you want to clear all Nifty 50 levels?')) {
        fetch('/levels/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                index_type: 'NIFTY_50',
                today_only: false
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                niftyLevels = [];
                renderNiftyLevels();
                alert(`Cleared ${data.deleted_count} level(s)`);
            } else {
                alert('Error clearing levels: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error clearing levels: ' + error.message);
        });
    }
}

function renderNiftyLevels() {
    const container = document.getElementById('niftyLevelsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    niftyLevels.forEach((level, index) => {
        const levelDiv = document.createElement('div');
        levelDiv.className = 'flex items-center gap-2';
        levelDiv.innerHTML = `
            <div class="flex-1">
                <input type="number" id="niftyLevelInput_${level.uuid}" 
                       placeholder="Enter level value" 
                       class="input input-bordered input-sm w-full" 
                       step="0.01" 
                       value="${level.value || ''}">
            </div>
            <button class="btn btn-primary btn-sm px-3" onclick="setNiftyLevel('${level.uuid}')">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </button>
            <button class="btn btn-error btn-sm px-3" onclick="deleteNiftyLevel('${level.uuid}')">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
            <div class="flex-1 min-w-0">
                <div class="text-xs text-gray-600 truncate" id="niftyLevelStatus_${level.uuid}">
                    ${level.value ? `â‚¹${level.value.toFixed(2)}` : 'Not set'}
                </div>
                <div class="text-xs text-gray-500 truncate" id="niftyLevelDistance_${level.uuid}"></div>
            </div>
        `;
        container.appendChild(levelDiv);
    });
    
    // Update displays for all levels
    niftyLevels.forEach(level => {
        updateNiftyLevelDisplay(level.uuid);
    });
}

function updateNiftyLevelDisplay(uuid) {
    const level = niftyLevels.find(l => l.uuid === uuid);
    if (!level) return;
    
    const statusElement = document.getElementById(`niftyLevelStatus_${uuid}`);
    const distanceElement = document.getElementById(`niftyLevelDistance_${uuid}`);
    
    if (!statusElement || !distanceElement) return;
    
    if (level.value !== null) {
        statusElement.textContent = `â‚¹${level.value.toFixed(2)}`;
        statusElement.className = 'text-xs text-success font-semibold';
        
        if (niftyPrice > 0) {
            const distance = Math.abs(niftyPrice - level.value);
            const distancePercent = (distance / level.value) * 100;
            distanceElement.textContent = `â‚¹${distance.toFixed(2)} (${distancePercent.toFixed(1)}%)`;
            
            // Color code based on distance
            if (distancePercent <= 1) {
                distanceElement.className = 'text-xs text-error font-semibold';
            } else if (distancePercent <= 5) {
                distanceElement.className = 'text-xs text-warning font-semibold';
            } else {
                distanceElement.className = 'text-xs text-gray-500';
            }
        }
    } else {
        statusElement.textContent = 'Not set';
        statusElement.className = 'text-xs text-gray-600';
        distanceElement.textContent = '';
    }
}

function updateBankNiftyPrice(price) {
    const previousPrice = bankNiftyPrice;
    bankNiftyPrice = price;
    const priceDisplay = document.getElementById('bankCurrentPriceDisplay');
    const timeDisplay = document.getElementById('bankPriceUpdateTime');
    if (priceDisplay) priceDisplay.textContent = `â‚¹${price.toFixed(2)}`;
    if (timeDisplay) timeDisplay.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    
    // Check for level breaches
    checkBankLevelBreaches(price, previousPrice);
    
    // Update all bank level displays
    bankLevels.forEach(level => {
        updateBankLevelDisplay(level.uuid);
    });
}

function updateNiftyPrice(price) {
    const previousPrice = niftyPrice;
    niftyPrice = price;
    const priceDisplay = document.getElementById('niftyCurrentPriceDisplay');
    const timeDisplay = document.getElementById('niftyPriceUpdateTime');
    if (priceDisplay) priceDisplay.textContent = `â‚¹${price.toFixed(2)}`;
    if (timeDisplay) timeDisplay.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    
    // Check for level breaches
    checkNiftyLevelBreaches(price, previousPrice);
    
    // Update all nifty level displays
    niftyLevels.forEach(level => {
        updateNiftyLevelDisplay(level.uuid);
    });
}

// Level breach detection functions
function checkBankLevelBreaches(currentPrice, previousPrice) {
    bankLevels.forEach((level, index) => {
        if (level.value !== null) {
            const breach = checkLevelBreach(currentPrice, previousPrice, level.value);
            
            if (breach.breached) {
                showBreachNotification('Bank Nifty', index + 1, level.value, currentPrice, breach.direction);
                updateBankLevelBreachStatus(level.uuid, breach);
            } else {
                updateBankLevelBreachStatus(level.uuid, { breached: false });
            }
        }
    });
}

function checkNiftyLevelBreaches(currentPrice, previousPrice) {
    niftyLevels.forEach((level, index) => {
        if (level.value !== null) {
            const breach = checkLevelBreach(currentPrice, previousPrice, level.value);
            
            if (breach.breached) {
                showBreachNotification('Nifty 50', index + 1, level.value, currentPrice, breach.direction);
                updateNiftyLevelBreachStatus(level.uuid, breach);
            } else {
                updateNiftyLevelBreachStatus(level.uuid, { breached: false });
            }
        }
    });
}

function checkLevelBreach(currentPrice, previousPrice, level) {
    if (!previousPrice || previousPrice === 0) {
        // No previous price data, can't determine crossing
        return { breached: false, direction: null };
    }
    
    // Check if price crossed the level
    const wasAbove = previousPrice > level;
    const isAbove = currentPrice > level;
    const wasBelow = previousPrice < level;
    const isBelow = currentPrice < level;
    
    // Determine if there was a crossing
    if (wasAbove && isBelow) {
        // Price crossed down through the level
        return { breached: true, direction: 'down' };
    } else if (wasBelow && isAbove) {
        // Price crossed up through the level
        return { breached: true, direction: 'up' };
    } else if (Math.abs(currentPrice - level) <= 0.01) {
        // Price is exactly at the level (within 0.01 tolerance)
        return { breached: true, direction: 'at_level' };
    }
    
    return { breached: false, direction: null };
}

function showBreachNotification(indexName, levelNumber, level, currentPrice, direction) {
    const directionText = direction === 'up' ? 'UP' : direction === 'down' ? 'DOWN' : 'AT';
    const directionColor = direction === 'up' ? 'text-success' : direction === 'down' ? 'text-error' : 'text-warning';
    
    console.log(`ðŸš¨ BREACH DETECTED: ${indexName} Level ${levelNumber} (â‚¹${level.toFixed(2)}) crossed ${directionText} at â‚¹${currentPrice.toFixed(2)}`);
    
    // Create a visual notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${direction === 'up' ? 'success' : direction === 'down' ? 'error' : 'warning'} mb-2`;
    notification.innerHTML = `
        <div class="flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div>
                <div class="font-semibold">${indexName} Level ${levelNumber} Breached!</div>
                <div class="text-sm">Level: â‚¹${level.toFixed(2)} | Price: â‚¹${currentPrice.toFixed(2)} | Direction: <span class="${directionColor} font-bold">${directionText}</span></div>
            </div>
        </div>
    `;
    
    // Add to alerts section or create a notifications area
    const alertsSection = document.querySelector('.card-body');
    if (alertsSection) {
        alertsSection.insertBefore(notification, alertsSection.firstChild);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 10000);
    }
}

function updateBankLevelBreachStatus(uuid, breach) {
    const statusElement = document.getElementById(`bankLevelStatus_${uuid}`);
    const distanceElement = document.getElementById(`bankLevelDistance_${uuid}`);
    
    if (!statusElement || !distanceElement) return;
    
    if (breach.breached) {
        const directionIcon = breach.direction === 'up' ? 'â†—ï¸' : breach.direction === 'down' ? 'â†˜ï¸' : 'âš¡';
        const directionColor = breach.direction === 'up' ? 'text-success' : breach.direction === 'down' ? 'text-error' : 'text-warning';
        
        statusElement.innerHTML = `${directionIcon} BREACHED`;
        statusElement.className = `text-xs ${directionColor} font-bold animate-pulse`;
        
        distanceElement.textContent = `Direction: ${breach.direction.toUpperCase()}`;
        distanceElement.className = `text-xs ${directionColor} font-semibold`;
    } else {
        // Reset to normal display
        updateBankLevelDisplay(uuid);
    }
}

function updateNiftyLevelBreachStatus(uuid, breach) {
    const statusElement = document.getElementById(`niftyLevelStatus_${uuid}`);
    const distanceElement = document.getElementById(`niftyLevelDistance_${uuid}`);
    
    if (!statusElement || !distanceElement) return;
    
    if (breach.breached) {
        const directionIcon = breach.direction === 'up' ? 'â†—ï¸' : breach.direction === 'down' ? 'â†˜ï¸' : 'âš¡';
        const directionColor = breach.direction === 'up' ? 'text-success' : breach.direction === 'down' ? 'text-error' : 'text-warning';
        
        statusElement.innerHTML = `${directionIcon} BREACHED`;
        statusElement.className = `text-xs ${directionColor} font-bold animate-pulse`;
        
        distanceElement.textContent = `Direction: ${breach.direction.toUpperCase()}`;
        distanceElement.className = `text-xs ${directionColor} font-semibold`;
    } else {
        // Reset to normal display
        updateNiftyLevelDisplay(uuid);
    }
}

// Database functions for three levels
function saveLevelToDatabase(indexType, levelValue, levelUuid = null) {
    return fetch('/levels/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            index_type: indexType,
            level_value: levelValue,
            uuid: levelUuid
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Level saved to database:', data.uuid);
            // Update UUID in the level object
            if (data.uuid) {
                if (indexType === 'BANK_NIFTY') {
                    const level = bankLevels.find(l => l.uuid.startsWith('temp_') || l.uuid === levelUuid);
                    if (level) {
                        level.uuid = data.uuid;
                        console.log('Updated Bank Nifty level UUID:', level);
                    }
                } else {
                    const level = niftyLevels.find(l => l.uuid.startsWith('temp_') || l.uuid === levelUuid);
                    if (level) {
                        level.uuid = data.uuid;
                        console.log('Updated Nifty level UUID:', level);
                    }
                }
            }
            return data;
        } else {
            console.error('Error saving level:', data.error);
            throw new Error(data.error || 'Failed to save level');
        }
    })
    .catch(error => {
        console.error('Error saving level:', error);
        throw error;
    });
}

function loadLevelsFromDatabase(todayOnly = false) {
    console.log('Loading levels from database...', todayOnly ? '(today only)' : '(all)');
    
    // Ensure containers exist before loading
    const bankContainer = document.getElementById('bankLevelsContainer');
    const niftyContainer = document.getElementById('niftyLevelsContainer');
    
    if (!bankContainer || !niftyContainer) {
        console.warn('Level containers not found, retrying in 100ms...');
        setTimeout(() => loadLevelsFromDatabase(todayOnly), 100);
        return;
    }
    
    const url = todayOnly ? '/levels/get?today_only=true' : '/levels/get';
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Levels API response:', data);
            if (data.success && data.levels) {
                // Load Bank Nifty levels (now as array)
                if (data.levels.BANK_NIFTY && Array.isArray(data.levels.BANK_NIFTY)) {
                    bankLevels = data.levels.BANK_NIFTY.map(level => ({
                        uuid: level.uuid,
                        value: level.value
                    }));
                    console.log(`Loaded ${bankLevels.length} Bank Nifty levels:`, bankLevels);
                } else {
                    console.log('No Bank Nifty levels found or invalid format');
                    bankLevels = [];
                }
                
                // Load Nifty 50 levels (now as array)
                if (data.levels.NIFTY_50 && Array.isArray(data.levels.NIFTY_50)) {
                    niftyLevels = data.levels.NIFTY_50.map(level => ({
                        uuid: level.uuid,
                        value: level.value
                    }));
                    console.log(`Loaded ${niftyLevels.length} Nifty 50 levels:`, niftyLevels);
                } else {
                    console.log('No Nifty 50 levels found or invalid format');
                    niftyLevels = [];
                }
                
                // Render the levels
                renderBankLevels();
                renderNiftyLevels();
                
                console.log('Levels loaded and rendered from database');
            } else {
                console.warn('API response missing success or levels:', data);
                // Initialize empty arrays if no data
                bankLevels = [];
                niftyLevels = [];
                renderBankLevels();
                renderNiftyLevels();
            }
        })
        .catch(error => {
            console.error('Error loading levels from database:', error);
            // Initialize empty arrays on error
            bankLevels = [];
            niftyLevels = [];
            renderBankLevels();
            renderNiftyLevels();
        });
}

// Paper Trades Functions
function loadPaperTrades() {
    // Get date filter value (defaults to today)
    const dateFilter = document.getElementById('paperTradesDateFilter')?.value || new Date().toISOString().split('T')[0];
    
    // Build query string
    const params = new URLSearchParams();
    if (dateFilter) {
        params.append('date', dateFilter);
    }
    
    fetch(`/trading/get-paper-trades?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPaperTrades(data.trades || [], data.date_filter);
            } else {
                showPaperTradesError(data.error || 'Failed to load paper trades');
            }
        })
        .catch(error => {
            console.error('Error loading paper trades:', error);
            showPaperTradesError('Error loading paper trades: ' + error.message);
        });
}

function renderPaperTrades(trades, dateFilter) {
    const container = document.getElementById('paperTradesContainer');
    if (!container) return;
    
    if (trades.length === 0) {
        const dateDisplay = dateFilter ? ` for ${new Date(dateFilter).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}` : '';
        container.innerHTML = `
            <div class="text-center text-base-content/60 py-8">
                <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p>No paper trades found${dateDisplay}</p>
            </div>
        `;
        return;
    }
    
    // Group trades by status
    const openTrades = trades.filter(t => t.status === 'OPEN');
    const closedTrades = trades.filter(t => t.status === 'CLOSED');
    
    let html = '';
    
    // Open Trades Section
    if (openTrades.length > 0) {
        html += `
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span class="badge badge-success badge-lg">${openTrades.length}</span>
                    Open Trades
                </h3>
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Instrument</th>
                                <th>Qty</th>
                                <th>Entry Price</th>
                                <th>Current Price</th>
                                <th>Target</th>
                                <th>Stop Loss</th>
                                <th>P&L</th>
                                <th>Entry Time</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        openTrades.forEach(trade => {
            const currentPrice = trade.current_price || 0;
            const entryPrice = trade.entry_price || 0;
            const pnl = currentPrice > 0 && entryPrice > 0 ? (currentPrice - entryPrice) * trade.quantity : 0;
            const pnlPercent = entryPrice > 0 ? ((currentPrice - entryPrice) / entryPrice) * 100 : 0;
            const pnlClass = pnl >= 0 ? 'text-success' : 'text-error';
            
            html += `
                <tr>
                    <td class="font-mono text-sm">${trade.tradingsymbol || 'N/A'}</td>
                    <td>
                        <span class="badge ${trade.option_type === 'CALL' ? 'badge-success' : 'badge-error'}">
                            ${trade.option_type || 'N/A'}
                        </span>
                    </td>
                    <td>${trade.instrument || 'N/A'}</td>
                    <td>${trade.quantity || 0}</td>
                    <td>â‚¹${parseFloat(trade.entry_price || 0).toFixed(2)}</td>
                    <td>${currentPrice > 0 ? 'â‚¹' + parseFloat(currentPrice).toFixed(2) : 'N/A'}</td>
                    <td>â‚¹${parseFloat(trade.target_price || 0).toFixed(2)}</td>
                    <td>â‚¹${parseFloat(trade.stoploss_price || 0).toFixed(2)}</td>
                    <td class="${pnlClass} font-semibold">
                        ${currentPrice > 0 ? (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + ' (' + (pnlPercent >= 0 ? '+' : '') + pnlPercent.toFixed(2) + '%)' : 'N/A'}
                    </td>
                    <td class="text-xs">${formatDateTime(trade.entry_time)}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    // Closed Trades Section
    if (closedTrades.length > 0) {
        html += `
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span class="badge badge-lg">${closedTrades.length}</span>
                    Closed Trades
                </h3>
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Instrument</th>
                                <th>Qty</th>
                                <th>Entry Price</th>
                                <th>Exit Price</th>
                                <th>Exit Reason</th>
                                <th>P&L</th>
                                <th>Entry Time</th>
                                <th>Exit Time</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        closedTrades.forEach(trade => {
            const pnl = trade.profit_loss || 0;
            const pnlPercent = trade.profit_loss_percent || 0;
            const pnlClass = pnl >= 0 ? 'text-success' : 'text-error';
            const exitReasonBadge = trade.exit_reason === 'TARGET' ? 'badge-success' : 
                                   trade.exit_reason === 'STOPLOSS' ? 'badge-error' : 'badge-warning';
            
            html += `
                <tr>
                    <td class="font-mono text-sm">${trade.tradingsymbol || 'N/A'}</td>
                    <td>
                        <span class="badge ${trade.option_type === 'CALL' ? 'badge-success' : 'badge-error'}">
                            ${trade.option_type || 'N/A'}
                        </span>
                    </td>
                    <td>${trade.instrument || 'N/A'}</td>
                    <td>${trade.quantity || 0}</td>
                    <td>â‚¹${parseFloat(trade.entry_price || 0).toFixed(2)}</td>
                    <td>â‚¹${parseFloat(trade.exit_price || 0).toFixed(2)}</td>
                    <td>
                        <span class="badge ${exitReasonBadge}">
                            ${trade.exit_reason || 'N/A'}
                        </span>
                    </td>
                    <td class="${pnlClass} font-semibold">
                        ${(pnl >= 0 ? '+' : '') + pnl.toFixed(2)} (${(pnlPercent >= 0 ? '+' : '') + pnlPercent.toFixed(2)}%)
                    </td>
                    <td class="text-xs">${formatDateTime(trade.entry_time)}</td>
                    <td class="text-xs">${formatDateTime(trade.exit_time)}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function showPaperTradesError(message) {
    const container = document.getElementById('paperTradesContainer');
    if (!container) return;
    
    container.innerHTML = `
        <div class="alert alert-error">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>${message}</span>
        </div>
    `;
}

function formatDateTime(dateTimeString) {
    if (!dateTimeString) return 'N/A';
    try {
        const date = new Date(dateTimeString);
        return date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateTimeString;
    }
}

// Refresh button handler
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date filter to today's date
    const dateFilterInput = document.getElementById('paperTradesDateFilter');
    if (dateFilterInput) {
        const today = new Date().toISOString().split('T')[0];
        dateFilterInput.value = today;
        
        // Add change event listener to reload trades when date changes
        dateFilterInput.addEventListener('change', function() {
            loadPaperTrades();
        });
    }
    
    const refreshBtn = document.getElementById('refreshPaperTrades');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            const btn = this;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Refreshing...';
            btn.disabled = true;
            
            loadPaperTrades();
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 1000);
        });
    }
    
    // Load paper trades on page load
    loadPaperTrades();
    
    // Auto-refresh paper trades every 30 seconds
    setInterval(loadPaperTrades, 30000);
});
</script>
{% endblock %}