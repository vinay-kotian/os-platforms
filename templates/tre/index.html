{% extends "base.html" %}

{% block title %}Trade Rule Engine - Eldorado{% endblock %}

{% block head %}
<style>
    .signal-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .signal-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-slate-900 mb-2">
            <i class="fas fa-robot text-indigo-600"></i> Trade Rule Engine (TRE)
        </h1>
        <p class="text-slate-600">Configure trading rules and view generated trade signals</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- TRE Settings Card -->
        <div class="bg-white rounded-lg shadow-md border border-slate-200 p-6">
            <h2 class="text-xl font-bold text-slate-900 mb-4">
                <i class="fas fa-cog text-indigo-600"></i> TRE Settings
            </h2>
            
            <form id="treSettingsForm" onsubmit="event.preventDefault(); updateSettings();">
                <div class="space-y-4">
                    <!-- Stop Loss -->
                    <div>
                        <label for="stopLoss" class="block text-sm font-medium text-slate-700 mb-1">
                            Stop Loss (%)
                        </label>
                        <input type="number" id="stopLoss" step="0.1" min="0" max="100" required
                               value="{{ tre_settings.stop_loss_percent if tre_settings else 2.0 }}"
                               class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-slate-500 mt-1">Percentage below/above entry price for stop loss</p>
                    </div>
                    
                    <!-- Target -->
                    <div>
                        <label for="target" class="block text-sm font-medium text-slate-700 mb-1">
                            Target (%)
                        </label>
                        <input type="number" id="target" step="0.1" min="0" max="100" required
                               value="{{ tre_settings.target_percent if tre_settings else 5.0 }}"
                               class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-slate-500 mt-1">Percentage above/below entry price for target</p>
                    </div>
                    
                    <!-- Trend Lookback -->
                    <div>
                        <label for="lookback" class="block text-sm font-medium text-slate-700 mb-1">
                            Trend Lookback (minutes)
                        </label>
                        <input type="number" id="lookback" step="1" min="1" max="60" required
                               value="{{ tre_settings.trend_lookback_minutes if tre_settings else 20 }}"
                               class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-slate-500 mt-1">Number of minutes to analyze for trend detection</p>
                    </div>
                    
                    <!-- Active Toggle -->
                    <div class="flex items-center">
                        <input type="checkbox" id="isActive" 
                               {% if not tre_settings or tre_settings.is_active %}checked{% endif %}
                               class="mr-2 w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500">
                        <label for="isActive" class="text-sm font-medium text-slate-700">
                            Enable TRE
                        </label>
                    </div>
                    
                    <!-- Submit Button -->
                    <button type="submit" 
                            class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                        <i class="fas fa-save mr-2"></i>Save Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- Trade Signals Card -->
        <div class="bg-white rounded-lg shadow-md border border-slate-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-900">
                    <i class="fas fa-signal text-emerald-600"></i> Trade Signals
                </h2>
                <button onclick="refreshSignals()" 
                        class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                </button>
            </div>
            
            <div id="signalsContainer" class="space-y-3 max-h-96 overflow-y-auto">
                {% if trade_signals %}
                    {% for signal in trade_signals %}
                    <div class="signal-card bg-slate-50 rounded-lg p-4 border border-slate-200">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-semibold text-slate-900">{{ signal.symbol }}</h3>
                                <p class="text-xs text-slate-500">{{ signal.exchange }}</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full 
                                {% if signal.option_type == 'CALL' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ signal.option_type }}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-sm mt-3">
                            <div>
                                <span class="text-slate-500">Entry:</span>
                                <span class="font-semibold text-slate-900 ml-1">₹{{ "%.2f"|format(signal.entry_price|float) }}</span>
                            </div>
                            <div>
                                <span class="text-slate-500">Trend:</span>
                                <span class="font-semibold {% if signal.trend_direction == 'uptrend' %}text-green-600{% else %}text-red-600{% endif %} ml-1">
                                    {{ signal.trend_direction|title }}
                                </span>
                            </div>
                            <div>
                                <span class="text-slate-500">SL:</span>
                                <span class="font-semibold text-red-600 ml-1">₹{{ "%.2f"|format(signal.stop_loss|float) }}</span>
                            </div>
                            <div>
                                <span class="text-slate-500">Target:</span>
                                <span class="font-semibold text-green-600 ml-1">₹{{ "%.2f"|format(signal.target|float) }}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-200">
                            <span class="px-2 py-1 text-xs rounded-full 
                                {% if signal.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif signal.status == 'sent' %}bg-blue-100 text-blue-800
                                {% elif signal.status == 'executed' %}bg-green-100 text-green-800
                                {% elif signal.status == 'closed' %}bg-slate-100 text-slate-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ signal.status|title }}
                            </span>
                            <span class="text-xs text-slate-500">
                                {{ signal.created_at[:16]|replace('T', ' ') }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-slate-300 text-4xl mb-3"></i>
                        <p class="text-slate-500">No trade signals yet</p>
                        <p class="text-xs text-slate-400 mt-1">Signals will appear here when alerts are triggered</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
async function updateSettings() {
    const stopLoss = parseFloat(document.getElementById('stopLoss').value);
    const target = parseFloat(document.getElementById('target').value);
    const lookback = parseInt(document.getElementById('lookback').value);
    const isActive = document.getElementById('isActive').checked;
    
    try {
        const response = await fetch('/tre/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                stop_loss_percent: stopLoss,
                target_percent: target,
                trend_lookback_minutes: lookback,
                is_active: isActive
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Settings saved successfully!');
        } else {
            alert(`Error: ${data.error || 'Failed to save settings'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
    }
}

async function refreshSignals() {
    try {
        const response = await fetch('/tre/api/signals');
        const data = await response.json();
        
        if (data.success) {
            // Reload page to show updated signals
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>
{% endblock %}

